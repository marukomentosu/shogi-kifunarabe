<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HTML将棋 Ultra - High Visibility</title>
    <style>
        :root {
            --bg-deep: #121212;
            --bg-panel: #1e1e1e;
            --board-dark: #3a2a1d;
            --cell-border: #554433;
            --text-main: #e0e0e0;
            --text-accent: #ffcc00;
            --selected-bg: rgba(255, 204, 0, 0.4);
            --btn-bg: #333333;
            --btn-border: #444444;
            --cell-size: min(10.5vw, 5.8vh, 50px);
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
        
        body {
            font-family: 'Hiragino Mincho ProN', serif;
            display: flex; flex-direction: column;
            height: 100dvh; margin: 0; background: var(--bg-deep);
            color: var(--text-main); overflow: hidden; padding: 4px;
        }

        .game-container {
            flex: 1; display: flex; flex-direction: column;
            align-items: center; justify-content: center; gap: 4px;
            min-height: 0;
        }
        .game-container.rotated { flex-direction: column-reverse; }

        .komadai {
            width: 98%; max-width: 500px; height: 50px;
            background: var(--bg-panel); border: 1px solid var(--btn-border);
            display: flex; align-items: center; padding: 0 10px;
            border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.4);
        }
        .player-name {
            font-size: 13px; font-weight: bold; margin-right: 8px;
            color: var(--text-accent); max-width: 85px; overflow: hidden; text-overflow: ellipsis;
        }
        .hand-container { display: flex; gap: 6px; flex: 1; overflow-x: auto; align-items: center; }
        
        /* 持ち駒のスタイルと選択時のエフェクト */
        .hand-piece { 
            font-size: 22px; cursor: pointer; color: #fdf5e6; 
            padding: 2px 4px; border-radius: 4px; transition: all 0.2s;
        }
        .hand-piece.selected { 
            background: var(--selected-bg);
            box-shadow: 0 0 12px var(--text-accent);
            transform: scale(1.25); /* 選択時に大きくする */
            color: #fff;
            font-weight: bold;
        }

        .board-wrapper { display: flex; flex-direction: column; align-items: center; }
        .status-msg { height: 20px; color: var(--text-accent); font-weight: bold; font-size: 14px; margin-bottom: 2px; transition: all 0.3s; }
        
        .board {
            display: grid; grid-template-columns: repeat(9, var(--cell-size));
            background: var(--board-dark); border: 2px solid #000;
        }
        .board.rotated { transform: rotate(180deg); }

        .cell {
            width: var(--cell-size); height: var(--cell-size);
            border: 0.5px solid var(--cell-border); display: flex;
            align-items: center; justify-content: center;
            font-size: calc(var(--cell-size) * 0.7); cursor: pointer;
            color: #fdf5e6; transition: background 0.2s;
        }
        .cell.selected { background: var(--selected-bg); box-shadow: inset 0 0 10px var(--text-accent); }
        .cell.last-move { background: rgba(255, 100, 0, 0.15); }
        .p-flip { transform: rotate(180deg); }

        /* 棋譜オーバーレイ */
        #kifu-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.92); z-index: 200; flex-direction: column; padding: 15px;
        }
        #kifu-list {
            flex: 1; overflow-y: auto; background: #000; border-radius: 8px;
            padding: 8px; display: flex; flex-wrap: wrap; gap: 5px; align-content: flex-start;
        }
        .kifu-line { cursor: pointer; padding: 6px 10px; background: #222; border-radius: 4px; color: #aaa; font-size: 13px; }
        .kifu-line.active { background: var(--text-accent); color: #000; font-weight: bold; }

        /* ボトムコントロール */
        .bottom-area { width: 100%; max-width: 500px; display: flex; flex-direction: column; gap: 4px; margin-top: 4px; }
        .controls { display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px; }
        .nav-group { grid-column: span 4; display: flex; gap: 4px; }
        
        button {
            padding: 10px 2px; cursor: pointer; background: var(--btn-bg);
            border: 1px solid var(--btn-border); border-radius: 6px;
            color: var(--text-main); font-weight: bold; font-size: 12px;
        }
        .btn-action { background: #2a2a2a; }
        .btn-undo { background: #3d3010; color: var(--text-accent); }
        .btn-resign { background: #3d1010; color: #ff6666; }
        .btn-reset { background: #222244; color: #99ccff; }
        .btn-save { background: #114422; color: #66ff99; grid-column: span 4; padding: 12px; margin-top: 2px; }

        /* モーダル */
        #modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 300; align-items: center; justify-content: center;
        }
        .modal-content {
            background: var(--bg-panel); padding: 15px; border-radius: 12px;
            width: 90%; max-width: 380px; display: flex; flex-direction: column; gap: 10px;
        }
        .modal-content input {
            background: #000; border: 1px solid var(--btn-border); padding: 12px;
            color: var(--text-main); border-radius: 6px; font-size: 16px; width: 100%;
        }
        .modal-row { display: flex; flex-direction: column; gap: 4px; }
        label { font-size: 11px; color: var(--text-accent); opacity: 0.8; }
    </style>
</head>
<body>

<div id="kifu-overlay" onclick="toggleKifu(false)">
    <h3 style="color:var(--text-accent); margin:0 0 10px 0; font-size:16px;">棋譜履歴 (タップで戻る)</h3>
    <div id="kifu-list" onclick="event.stopPropagation()"></div>
    <button onclick="toggleKifu(false)" style="margin-top:10px; width:100%; background:#444;">閉じる</button>
</div>

<div id="modal-overlay">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h3 id="modal-title" style="margin:0; color:var(--text-accent); font-size:18px;">対局設定</h3>
        <div class="modal-row"><label>棋戦名</label><input type="text" id="event" placeholder="例：練習対局"></div>
        <div class="modal-row">
            <label>対局日</label>
            <div style="display:flex; gap:5px;">
                <input type="text" id="date-text" style="flex:1">
                <input type="date" id="date-picker" style="width:45px; padding:5px;" onchange="document.getElementById('date-text').value = this.value.replace(/-/g,'/')">
            </div>
        </div>
        <div class="modal-row">
            <label>先手氏名 / 後手氏名</label>
            <div style="display:flex; gap:5px;">
                <input type="text" id="sente-input" placeholder="先手" style="flex:1">
                <input type="text" id="gote-input" placeholder="後手" style="flex:1">
            </div>
        </div>
        <div id="filename-area" style="display:none;" class="modal-row"><label>保存ファイル名 (.kif)</label><input type="text" id="filename-input"></div>
        <div style="display:flex; gap:8px; margin-top:5px;">
            <button onclick="closeSettings()" style="flex:1">キャンセル</button>
            <button id="save-final-btn" style="flex:1; background:#114422; color:#66ff99; border:none; display:none;" onclick="executeDownload()">保存を実行</button>
        </div>
    </div>
</div>

<div class="game-container" id="main-container">
    <div class="komadai" id="hand-gote">
        <div class="player-name" id="name-display-gote">後手</div>
        <div class="hand-container"></div>
    </div>
    <div class="board-wrapper">
        <div class="status-msg" id="msg">先手番</div>
        <div id="board" class="board"></div>
    </div>
    <div class="komadai" id="hand-sente">
        <div class="player-name" id="name-display-sente">先手</div>
        <div class="hand-container"></div>
    </div>
</div>

<div class="bottom-area">
    <div class="controls">
        <div class="nav-group">
            <button onclick="jumpTo(0)" style="flex:1">|◀</button>
            <button onclick="prevMove()" style="flex:1.5">◀ 前へ</button>
            <button onclick="nextMove()" style="flex:1.5">次へ ▶</button>
            <button onclick="jumpTo(history.length - 1)" style="flex:1">▶|</button>
        </div>
        <button class="btn-undo" onclick="undoMove()">一手戻す</button>
        <button class="btn-action" onclick="toggleRotate()">盤反転</button>
        <button class="btn-action" onclick="toggleKifu(true)">棋譜</button>
        <button class="btn-reset" onclick="resetGame()">最初から</button>
        <button style="grid-column: span 2;" onclick="openSettings('info')">対局設定</button>
        <button style="grid-column: span 2;" class="btn-resign" onclick="resignGame()">投了</button>
        <button class="btn-save" onclick="openSettings('save')">棋譜を保存する (.kif)</button>
    </div>
</div>

<script>
    const P_MOVE = {
        '歩': { m: [[-1, 0]], up: 'と' }, '香': { m: [[-10, 0]], up: '杏' }, '桂': { m: [[-2, -1], [-2, 1]], up: '圭' },
        '銀': { m: [[-1, 0], [-1, -1], [-1, 1], [1, -1], [1, 1]], up: '全' }, '金': { m: [[-1, 0], [-1, -1], [-1, 1], [0, -1], [0, 1], [1, 0]], up: null },
        '角': { m: [[-10, -10], [-10, 10], [10, -10], [10, 10]], up: '馬' }, '飛': { m: [[-10, 0], [10, 0], [0, -10], [0, 10]], up: '龍' },
        '玉': { m: [[-1, 0], [1, 0], [0, -1], [0, 1], [-1, -1], [-1, 1], [1, -1], [1, 1]], up: null }, '王': { m: [[-1, 0], [1, 0], [0, -1], [0, 1], [-1, -1], [-1, 1], [1, -1], [1, 1]], up: null },
        'と': { m: [[-1, 0], [-1, -1], [-1, 1], [0, -1], [0, 1], [1, 0]], up: null }, '杏': { m: [[-1, 0], [-1, -1], [-1, 1], [0, -1], [0, 1], [1, 0]], up: null },
        '圭': { m: [[-1, 0], [-1, -1], [-1, 1], [0, -1], [0, 1], [1, 0]], up: null }, '全': { m: [[-1, 0], [-1, -1], [-1, 1], [0, -1], [0, 1], [1, 0]], up: null },
        '馬': { m: [[-10, -10], [-10, 10], [10, -10], [10, 10], [-1, 0], [1, 0], [0, -1], [0, 1]], up: null }, '龍': { m: [[-10, 0], [10, 0], [0, -10], [0, 10], [-1, -1], [-1, 1], [1, -1], [1, 1]], up: null }
    };

    let board, hands, turn, selected, history, currentIndex, result, isRotated = false;

    function init() {
        board = Array(9).fill().map(() => Array(9).fill(null));
        hands = { sente: { '歩':0,'香':0,'桂':0,'銀':0,'金':0,'角':0,'飛':0 }, gote: { '歩':0,'香':0,'桂':0,'銀':0,'金':0,'角':0,'飛':0 } };
        const l1 = ['香','桂','銀','金','玉','金','銀','桂','香'];
        l1.forEach((p, c) => board[0][c] = {p, owner:'gote'});
        board[1][1] = {p:'飛', owner:'gote'}; board[1][7] = {p:'角', owner:'gote'};
        for(let i=0; i<9; i++) board[2][i] = {p:'歩', owner:'gote'};
        for(let i=0; i<9; i++) board[6][i] = {p:'歩', owner:'sente'};
        board[7][1] = {p:'角', owner:'sente'}; board[7][7] = {p:'飛', owner:'sente'};
        l1.forEach((p, c) => board[8][c] = {p: p==='玉'?'玉':p, owner:'sente'});
        turn = 'sente'; selected = null; history = []; result = null;
        const now = new Date();
        if(!document.getElementById('date-text').value) {
            document.getElementById('date-text').value = `${now.getFullYear()}/${(now.getMonth()+1).toString().padStart(2,'0')}/${now.getDate().toString().padStart(2,'0')}`;
        }
        saveHistory("開始"); render();
    }

    function resetGame() {
        if (!confirm("最初から対局をやり直しますか？")) return;
        const si = document.getElementById('sente-input'), gi = document.getElementById('gote-input');
        si.value = si.value.replace(/[○×]$/, ''); gi.value = gi.value.replace(/[○×]$/, '');
        syncDisplayNames(); init();
    }

    function render() {
        const state = history[currentIndex];
        const boardEl = document.getElementById('board'); boardEl.innerHTML = '';
        const lastP = (currentIndex > 0) ? state.lastPos : null;
        for (let r = 0; r < 9; r++) {
            for (let c = 0; c < 9; c++) {
                const cell = document.createElement('div');
                cell.className = `cell ${selected?.type==='board' && selected?.r===r && selected?.c===c ? 'selected' : ''} ${lastP?.r===r && lastP?.c===c ? 'last-move' : ''}`;
                const d = state.board[r][c];
                if (d) { cell.textContent = d.p; if (d.owner === 'gote') cell.classList.add('p-flip'); }
                if (!result && currentIndex === history.length - 1) cell.onclick = () => handleCellClick(r, c);
                boardEl.appendChild(cell);
            }
        }
        updateHandUI('sente', state.hands.sente); updateHandUI('gote', state.hands.gote);
        updateStatus();
    }

    function updateHandUI(owner, handData) {
        const container = document.querySelector(`#hand-${owner} .hand-container`); container.innerHTML = '';
        for (const [p, count] of Object.entries(handData)) if (count > 0) {
            const el = document.createElement('div');
            // 選択されている駒には .selected を付与
            const isSelected = (selected?.type === 'hand' && selected.p === p && selected.owner === owner);
            el.className = `hand-piece ${isSelected ? 'selected' : ''}`;
            if (owner === 'gote') el.classList.add('p-flip');
            el.innerHTML = `${p}${count > 1 ? count : ''}`;
            if (!result && currentIndex === history.length - 1) el.onclick = (e) => { e.stopPropagation(); selectHand(p, owner); };
            container.appendChild(el);
        }
    }

    function toggleRotate() { isRotated = !isRotated; document.getElementById('board').classList.toggle('rotated'); document.getElementById('main-container').classList.toggle('rotated'); render(); }
    function toggleKifu(show) { document.getElementById('kifu-overlay').style.display = show ? 'flex' : 'none'; }
    function openSettings(mode) {
        const overlay = document.getElementById('modal-overlay');
        const fnameArea = document.getElementById('filename-area');
        const saveBtn = document.getElementById('save-final-btn');
        overlay.style.display = 'flex';
        if (mode === 'save') {
            document.getElementById('modal-title').textContent = "棋譜を保存する";
            fnameArea.style.display = 'block'; saveBtn.style.display = 'block';
            const sn = document.getElementById('sente-input').value.trim(), gn = document.getElementById('gote-input').value.trim();
            document.getElementById('filename-input').value = (sn || gn) ? `${sn}_${gn}` : `shogi_${Date.now()}`;
        } else {
            document.getElementById('modal-title').textContent = "対局設定";
            fnameArea.style.display = 'none'; saveBtn.style.display = 'none';
        }
    }
    function closeSettings() { syncDisplayNames(); document.getElementById('modal-overlay').style.display = 'none'; }
    function syncDisplayNames() {
        const sn = document.getElementById('sente-input').value.trim(), gn = document.getElementById('gote-input').value.trim();
        document.getElementById('name-display-sente').textContent = sn || "先手";
        document.getElementById('name-display-gote').textContent = gn || "後手";
    }

    function resignGame() {
        if (result || history.length < 2) return;
        if (!confirm("投了しますか？")) return;
        result = (turn === 'sente') ? 'gote_win' : 'sente_win';
        saveHistory(`${history.length} 投了`); 
        const si = document.getElementById('sente-input'), gi = document.getElementById('gote-input');
        if (result === 'sente_win') { si.value += "○"; gi.value += "×"; } else { si.value += "×"; gi.value += "○"; }
        syncDisplayNames(); render();
    }

    function undoMove() {
        if (history.length <= 1) return;
        history.pop(); board = JSON.parse(JSON.stringify(history[history.length - 1].board));
        hands = JSON.parse(JSON.stringify(history[history.length - 1].hands));
        turn = history[history.length - 1].turn;
        if (result) {
            const si = document.getElementById('sente-input'), gi = document.getElementById('gote-input');
            si.value = si.value.replace(/[○×]$/, ''); gi.value = gi.value.replace(/[○×]$/, '');
            result = null;
        }
        currentIndex = history.length - 1; syncDisplayNames(); updateKifuList(); render();
    }

    function executeDownload() {
        const sn = document.getElementById('sente-input').value || "先手", gn = document.getElementById('gote-input').value || "後手", fn = document.getElementById('filename-input').value || "record";
        let out = `V2.2\n棋戦：${document.getElementById('event').value || "無題"}\n開始日時：${document.getElementById('date-text').value}\n先手：${sn}\n後手：${gn}\n手数----指手---------\n` + history.slice(1).map(h => h.moveStr).join('\n') + '\n';
        const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), out], { type: 'text/plain;charset=utf-8' });
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `${fn}.kif`; a.click(); closeSettings();
    }

    // --- ロジック ---
    function saveHistory(moveStr) { history.push({ board: JSON.parse(JSON.stringify(board)), hands: JSON.parse(JSON.stringify(hands)), lastPos: history.length > 0 ? (history[history.length-1].lastPos) : null, turn, moveStr }); currentIndex = history.length - 1; updateKifuList(); }
    
    function selectHand(p, owner) { 
        if (turn === owner) { 
            if (selected?.type === 'hand' && selected.p === p) selected = null; // 再タップで解除
            else selected = { type: 'hand', p, owner }; 
            render(); 
        } 
    }

    function handleCellClick(r, c) {
        const clicked = board[r][c];
        if (selected?.type === 'hand') { if (!clicked) { if (checkIllegalDrop(selected.p, r, c)) return; executeMove(null, null, r, c, selected.p, true); } selected = null; }
        else if (selected) {
            if (selected.r === r && selected.c === c) selected = null;
            else if (canMove(board, selected.r, selected.c, r, c, turn)) { executeMove(selected.r, selected.c, r, c, selected.p); selected = null; }
            else if (clicked && clicked.owner === turn) selected = { r, c, p: clicked.p, type: 'board' };
            else selected = null;
        } else if (clicked && clicked.owner === turn) selected = { r, c, p: clicked.p, type: 'board' };
        render();
    }

    function canMove(b, fr, fc, tr, tc, owner) {
        const pData = b[fr][fc]; if (!pData) return false;
        const dest = b[tr][tc]; if (dest && dest.owner === owner) return false;
        const moves = P_MOVE[pData.p].m, mult = owner === 'sente' ? 1 : -1;
        for (let [mr, mc] of moves) {
            const trgR = mr * mult, trgC = mc * mult;
            if (Math.abs(mr) < 10) { if (tr - fr === trgR && tc - fc === trgC) return true; }
            else {
                const sR = Math.sign(trgR), sC = Math.sign(trgC);
                for (let i = 1; i < 9; i++) { const cR = fr + sR * i, cC = fc + sC * i; if (cR === tr && cC === tc) return true; if (cR < 0 || cR > 8 || cC < 0 || cC > 8 || b[cR][cC]) break; }
            }
        } return false;
    }

    function checkIllegalDrop(p, r, c) {
        if (p === '歩') for (let i = 0; i < 9; i++) if (board[i][c]?.p === '歩' && board[i][c]?.owner === turn) return (alert("二歩"), true);
        if (((p === '歩' || p === '香') && ((turn === 'sente' && r === 0) || (turn === 'gote' && r === 8))) || (p === '桂' && ((turn === 'sente' && r <= 1) || (turn === 'gote' && r >= 7)))) return (alert("行き所なし"), true);
        return false;
    }

    function executeMove(fr, fc, tr, tc, piece, isDrop = false) {
        let finalPiece = piece, suffix = "";
        if (isDrop) { hands[turn][piece]--; suffix = "打"; }
        else {
            if (board[tr][tc]) { const cap = board[tr][tc].p, rev = {'と':'歩','杏':'香','圭':'桂','全':'銀','馬':'角','龍':'飛'}; hands[turn][rev[cap] || cap]++; }
            if (P_MOVE[piece].up && ((turn === 'sente' && (fr <= 2 || tr <= 2)) || (turn === 'gote' && (fr >= 6 || tr >= 6)))) { if (confirm("成りますか？")) { finalPiece = P_MOVE[piece].up; suffix = "成"; } else suffix = "不成"; }
            board[fr][fc] = null;
        }
        board[tr][tc] = { p: finalPiece, owner: turn };
        const moveStr = `${history.length} ${"９８７６５４３２１"[tc]}${"一二三四五六七八九"[tr]}${finalPiece}${suffix}`;
        history[currentIndex].lastPos = {r: tr, c: tc}; turn = turn === 'sente' ? 'gote' : 'sente';
        saveHistory(moveStr); render();
    }

    function jumpTo(idx) { currentIndex = idx; render(); if(document.getElementById('kifu-overlay').style.display==='flex') toggleKifu(false); }
    function prevMove() { if (currentIndex > 0) jumpTo(currentIndex - 1); }
    function nextMove() { if (currentIndex < history.length - 1) jumpTo(currentIndex + 1); }
    
    function updateKifuList() {
        const log = document.getElementById('kifu-list'); log.innerHTML = '';
        history.forEach((h, i) => { const d = document.createElement('div'); d.className = `kifu-line ${i === currentIndex ? 'active' : ''}`; d.textContent = h.moveStr; d.onclick = () => jumpTo(i); log.appendChild(d); });
        log.scrollTop = log.scrollHeight;
    }

    function updateStatus() {
        const msg = document.getElementById('msg'); 
        if (result) { msg.textContent = `${result === 'sente_win' ? document.getElementById('name-display-sente').textContent : document.getElementById('name-display-gote').textContent} 勝`; return; }
        
        let turnStr = (history[currentIndex].turn === 'sente' ? '先手' : '後手');
        
        // 駒を選択中ならメッセージを変える
        if (selected) {
            if (selected.type === 'hand') msg.textContent = `【${selected.p}】を打つ場所を選んでください`;
            else msg.textContent = `【${selected.p}】の移動先を選んでください`;
        } else {
            msg.textContent = `${turnStr}番`;
        }
        
        if (currentIndex < history.length - 1) msg.textContent = "棋譜閲覧中";
    }
    init();
</script>
</body>
</html>
